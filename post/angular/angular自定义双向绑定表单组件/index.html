<!DOCTYPE html>
<html lang="en"><head>
    <title>rx-78-kum0</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content="#000084" />
    <link rel="icon" href="https://rx-78-kum0.github.io//favicon.ico">
    <link rel="canonical" href="https://rx-78-kum0.github.io/">
    
    
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"></button>
            <a class="brand" href="https://rx-78-kum0.github.io/">rx-78-kum0</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                    
                        
                            <li>
                                <a href="/post/">
                                    
                                    <span>Posts</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/about/">
                                    
                                    <span>About</span>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>
</nav><div id="content" class="container">

<div class="row-fluid navmargin">
    <div class="page-header">
        <h1>Angular自定义双向绑定表单组件 - Mon, Jul 8, 2019</h1>
    </div>
    <p class="lead">angular使用ControlValueAccessor抽象类实现响应式表单组件</p>
    <p>angular的ControlValueAccessor是一个连接表单模型和视图DOM的抽象类接口</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>使自定义表单组件像原生input一样映射到form表单模型中, 拥有自定义表单组件的form也能使用响应式表单.
(也就是使自定义表单组件拥有formControlName属性和ngModel接口.)</p>
<!-- raw HTML omitted -->
<p>毕竟响应式表单才是angular的利器.</p>
<h2 id="controlvalueaccessor">ControlValueAccessor</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ControlValueAccessor</span> {
  <span style="color:#a6e22e">writeValue</span>(<span style="color:#a6e22e">obj</span>: <span style="color:#66d9ef">any</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span>;
  <span style="color:#a6e22e">registerOnChange</span>(<span style="color:#a6e22e">fn</span>: <span style="color:#66d9ef">any</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span>;
  <span style="color:#a6e22e">registerOnTouched</span>(<span style="color:#a6e22e">fn</span>: <span style="color:#66d9ef">any</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span>;
  <span style="color:#a6e22e">setDisabledState</span><span style="color:#f92672">?</span>(<span style="color:#a6e22e">isDisabled</span>: <span style="color:#66d9ef">boolean</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span>;
}
</code></pre></div><h3 id="writevalue--obj-any">writeValue(obj: any):</h3>
<p>该方法是接收模版中的ngModel.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">writeValue</span>(<span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">any</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span> {
 <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_renderer</span>.<span style="color:#a6e22e">setProperty</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_elementRef</span>.<span style="color:#a6e22e">nativeElement</span>, <span style="color:#e6db74">&#39;value&#39;</span>, <span style="color:#a6e22e">value</span>);
}
</code></pre></div><h3 id="registeronchange--fn-any--void">registerOnChange(fn: any): void:</h3>
<p>该方法是组件接收到 change 事件的回调, 可以用来通知外部达成双向绑定, 即ngModelChange.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">registerOnChange</span>(<span style="color:#a6e22e">fn</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">_</span>: <span style="color:#66d9ef">any</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">void</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span> {
 <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_onChange</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fn</span>;
}
</code></pre></div><h3 id="registerontouched--fn-any">registerOnTouched(fn: any):</h3>
<p>接收到 touched 事件的回调.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">registerOnTouched</span>(<span style="color:#a6e22e">fn</span>: <span style="color:#66d9ef">any</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span> {
  <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_onTouched</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fn</span>;
}
</code></pre></div><h3 id="setdisabledstate--isdisabled-boolean">setDisabledState?(isDisabled: boolean):</h3>
<p>该方法是组件输入状态 disable &lt;=&gt; enable 变化时的回调。该方法会根据参数值，启用或禁用指定的DOM元素.</p>
<h2 id="以下组件类实现了controlvalueaccessor接口-dot">以下组件类实现了ControlValueAccessor接口.</h2>
<h3 id="checkboxcontrolvalueaccessor">CheckboxControlValueAccessor</h3>
<p>用于checkbox复选组件选择器:</p>
<ul>
<li>input[type=checkbox][formControlName]</li>
<li>input[type=checkbox][formControl]</li>
<li>input[type=checkbox][ngModel]</li>
</ul>
<h3 id="numbervalueaccessor">NumberValueAccessor</h3>
<p>用于number类型的输入组件选择器:</p>
<ul>
<li>input[type=number][formControlName]</li>
<li>input[type=number][formControl]</li>
<li>input[type=number][ngModel]</li>
</ul>
<h3 id="defaultvalueaccessor">DefaultValueAccessor</h3>
<p>用于 text 和 textarea 类型的输入组件选择器:</p>
<ul>
<li>input:not([type=checkbox])[formControlName]</li>
<li>textarea[formControlName]</li>
<li>input:not([type=checkbox])[formControl]</li>
<li>textarea[formControl]</li>
<li>input:not([type=checkbox])[ngModel]</li>
<li>textarea[ngModel]</li>
<li>[ngDefaultControl]</li>
</ul>
<h3 id="radiocontrolvalueaccessor">RadioControlValueAccessor</h3>
<p>用于radio单选组件选择器:</p>
<ul>
<li>input[type=radio][formControlName]</li>
<li>input[type=radio][formControl]</li>
<li>input[type=radio][ngModel]</li>
</ul>
<p>扩展方法:</p>
<ul>
<li>fireUncheck(value: any): void:取消选中的回调.</li>
</ul>
<h3 id="rangevalueaccessor">RangeValueAccessor</h3>
<p>用于范围输入组件选择器:</p>
<ul>
<li>input[type=range][formControlName]</li>
<li>input[type=range][formControl]</li>
<li>input[type=range][ngModel]</li>
</ul>
<h3 id="selectcontrolvalueaccessor">SelectControlValueAccessor</h3>
<p>用于select组件选择器:</p>
<ul>
<li>select:not([multiple])[formControlName]</li>
<li>select:not([multiple])[formControl]</li>
<li>select:not([multiple])[ngModel]</li>
</ul>
<p>扩展方法:</p>
<ul>
<li>compareWith: (o1: any, o2: any) =&gt; boolean:比较函数. 例如option的ngValue是一个对象, 当选中项填入表单时,需要编写一个比较函数来处理当前选中的对象是哪一个option.</li>
</ul>
<h3 id="selectmultiplecontrolvalueaccessor">SelectMultipleControlValueAccessor</h3>
<p>用于多选select组件选择器:</p>
<ul>
<li>select[multiple][formControlName]</li>
<li>select[multiple][formControl]</li>
<li>select[multiple][ngModel]</li>
</ul>
<p>扩展方法:
compareWith: (o1: any, o2: any) =&gt; boolean:比较函数. 例如option的ngValue是一个对象, 当选中项填入表单时, 需要编写一个比较函数来处理当前选中的对象是哪一个option.</p>
<h2 id="eg">EG</h2>
<h3 id="自定义表单组件代码结构">自定义表单组件代码结构</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">import</span> {
  <span style="color:#a6e22e">Component</span>,
  <span style="color:#a6e22e">OnInit</span>,
  <span style="color:#a6e22e">HostListener</span>,
  <span style="color:#a6e22e">ViewEncapsulation</span>,
  <span style="color:#a6e22e">forwardRef</span>,
  <span style="color:#a6e22e">Input</span>,
  <span style="color:#a6e22e">OnDestroy</span>,
  <span style="color:#a6e22e">ChangeDetectorRef</span>,
  <span style="color:#a6e22e">ChangeDetectionStrategy</span>
} <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;@angular/core&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">ControlValueAccessor</span>, <span style="color:#a6e22e">NG_VALUE_ACCESSOR</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;@angular/forms&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Subject</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;rxjs&#39;</span>;

<span style="color:#66d9ef">@Component</span>({
  <span style="color:#a6e22e">selector</span>       <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;[app-radiobox]&#39;</span>,
  <span style="color:#a6e22e">templateUrl</span>    <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;./radiobox.component.html&#39;</span>,
  <span style="color:#a6e22e">styleUrls</span>      <span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;./radiobox.component.styl&#39;</span>],
  <span style="color:#a6e22e">encapsulation</span>  : <span style="color:#66d9ef">ViewEncapsulation.None</span>,
  <span style="color:#a6e22e">changeDetection</span>: <span style="color:#66d9ef">ChangeDetectionStrategy.OnPush</span>,
  <span style="color:#a6e22e">host</span>           <span style="color:#f92672">:</span> {
    <span style="color:#e6db74">&#39;[class.radio-wrapper]&#39;</span>        <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;true&#39;</span>,
    <span style="color:#e6db74">&#39;[class.radio-wrapper-checked]&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;checked&#39;</span>
  },
  <span style="color:#a6e22e">providers</span><span style="color:#f92672">:</span> [
    {
      <span style="color:#a6e22e">provide</span>    : <span style="color:#66d9ef">NG_VALUE_ACCESSOR</span>,
      <span style="color:#a6e22e">useExisting</span>: <span style="color:#66d9ef">forwardRef</span>(() <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">RadioboxComponent</span>),
      <span style="color:#a6e22e">multi</span>      : <span style="color:#66d9ef">true</span>
    }
  ]
})
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RadioboxComponent</span> <span style="color:#66d9ef">implements</span> <span style="color:#a6e22e">OnInit</span>, <span style="color:#a6e22e">OnDestroy</span>, <span style="color:#a6e22e">ControlValueAccessor</span> {
  <span style="color:#66d9ef">@Input</span>()
  <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">boolean</span>;
  <span style="color:#a6e22e">checked</span>: <span style="color:#66d9ef">boolean</span>;
  <span style="color:#a6e22e">select$</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Subject</span>&lt;<span style="color:#f92672">RadioboxComponent</span>&gt;();

  <span style="color:#a6e22e">onChange</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">_</span>: <span style="color:#66d9ef">any</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">null</span>;
  <span style="color:#a6e22e">onTouched</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">null</span>;

  <span style="color:#66d9ef">constructor</span>(<span style="color:#66d9ef">private</span> <span style="color:#a6e22e">_cdr</span>: <span style="color:#66d9ef">ChangeDetectorRef</span>) {}

  <span style="color:#66d9ef">@HostListener</span>(<span style="color:#e6db74">&#39;click&#39;</span>, [<span style="color:#e6db74">&#39;$event&#39;</span>])
  <span style="color:#a6e22e">onClick</span>(<span style="color:#a6e22e">e</span>: <span style="color:#66d9ef">MouseEvent</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span> {
    <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">stopPropagation</span>();
    <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">preventDefault</span>();
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">checked</span> <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">checked</span>;
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">onChange</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">checked</span>);
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">select$</span>.<span style="color:#a6e22e">next</span>(<span style="color:#66d9ef">this</span>);
  }

  <span style="color:#a6e22e">writeValue</span>(<span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">boolean</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">checked</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
  }
  <span style="color:#a6e22e">registerOnChange</span>(<span style="color:#a6e22e">fn</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">_</span>: <span style="color:#66d9ef">boolean</span>) <span style="color:#f92672">=&gt;</span> {})<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span> {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">onChange</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fn</span>;
  }
  <span style="color:#a6e22e">registerOnTouched</span>(<span style="color:#a6e22e">fn</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {})<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span> {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">onTouched</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fn</span>;
  }

  <span style="color:#a6e22e">ngOnInit() {</span>}

  <span style="color:#a6e22e">ngOnDestroy() {</span>}
}
</code></pre></div><h3 id="调用">调用</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Component</span>, <span style="color:#a6e22e">OnInit</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;@angular/core&#39;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">FormBuilder</span>, <span style="color:#a6e22e">FormGroup</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;@angular/forms&#39;</span>;

<span style="color:#66d9ef">@Component</span>({
  <span style="color:#a6e22e">selector</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;app-example&#39;</span>,
  <span style="color:#a6e22e">template</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`
</span><span style="color:#e6db74">    &lt;form [formGroup]=&#34;testForm&#34;&gt;
</span><span style="color:#e6db74">      &lt;label&gt;试试&lt;/label&gt;
</span><span style="color:#e6db74">      &lt;label app-radiobox formControlName=&#34;check&#34;&gt;check me&lt;/label&gt;
</span><span style="color:#e6db74">    &lt;/form&gt;
</span><span style="color:#e6db74">  `</span>
})
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExampleComponent</span> <span style="color:#66d9ef">implements</span> <span style="color:#a6e22e">OnInit</span> {
  <span style="color:#a6e22e">testForm</span>: <span style="color:#66d9ef">FormGroup</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_fb</span>.<span style="color:#a6e22e">group</span>({
    <span style="color:#a6e22e">check</span>: <span style="color:#66d9ef">false</span>
  });
  <span style="color:#66d9ef">constructor</span>(<span style="color:#66d9ef">private</span> <span style="color:#a6e22e">_fb</span>: <span style="color:#66d9ef">FormBuilder</span>) {}

  <span style="color:#a6e22e">ngOnInit() {</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">testForm</span>.<span style="color:#a6e22e">valueChanges</span>.<span style="color:#a6e22e">subscribe</span>(<span style="color:#a6e22e">d</span> <span style="color:#f92672">=&gt;</span> {
      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">d</span>);
    });
  }
}
</code></pre></div>
    <h4><a href="https://rx-78-kum0.github.io/">Back to Home</a></h4>
</div>


        </div><footer class="container">
    <hr class="soften">
    <p>

&copy; 

    JM Fergeau

<span id="thisyear">2020</span>

</p>
    <p class="text-center">
        
        
        
        <a href="https://github.com/rx-78-kum0">GitHub</a> 
        
    </p>
</footer>

</body><link rel="stylesheet" href="/css/bootstrap.css">
<link rel="stylesheet" href="/css/bootstrap-responsive.css">
<link rel="stylesheet" href="/css/style.css">
<script src="/js/jquery.js"></script>
<script src="/js/bootstrap-386.js"></script>
<script src="/js/bootstrap-transition.js"></script>
<script src="/js/bootstrap-alert.js"></script>
<script src="/js/bootstrap-modal.js"></script>
<script src="/js/bootstrap-dropdown.js"></script>
<script src="/js/bootstrap-scrollspy.js"></script>
<script src="/js/bootstrap-tab.js"></script>
<script src="/js/bootstrap-tooltip.js"></script>
<script src="/js/bootstrap-popover.js"></script>
<script src="/js/bootstrap-button.js"></script>
<script src="/js/bootstrap-collapse.js"></script>
<script src="/js/bootstrap-carousel.js"></script>
<script src="/js/bootstrap-typeahead.js"></script>
<script src="/js/bootstrap-affix.js"></script>
<script>
    _386 = { 
        fastLoad: true ,
        onePass: true , 
        speedFactor: 5 
    };

    
    function ThisYear() {
        document.getElementById('thisyear').innerHTML = new Date().getFullYear();
    };
</script></html>
